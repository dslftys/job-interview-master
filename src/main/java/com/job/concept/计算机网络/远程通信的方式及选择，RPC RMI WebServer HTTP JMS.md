# 远程通信的方式及选择，RPC RMI WebServer HTTP JMS TCP/IP Socket

## 网络层次

	应用层       --  HTTP协议
	传输控制层    --  TCP/UDP协议  -> Socket封装
	网络层       --  IP协议、ICMP协议
	
## IP协议

IP协议处于网络层，用于更底层（数据链路层）与上层传输控制层(TCP/UDP)之间传输数据。通过解析或指定目的地址的IP，来确定一条网络计算机中的链路。

简单来说，就是通过IP来确定一台网络上的电脑，确立一条网络路径。

协议头：

* 版本：占4位，指IP协议的版本。
* 首部长度：占4位，可表示的最大十进制数值是15。
* 区分服务：占8位，用来获得更好的服务。
* 总长度：总长度指首部和数据之和的长度，单位为字节。总长度字段为16位，因此数据报的最大长度为216-1=65535字节。 
* 标识(identification)：占16位。
* 标志(flag)：占3位，但目前只有2位有意义。 
* 片偏移：占13位。
* 生存时间：占8位，生存时间字段常用的的英文缩写是TTL(Time To Live)，表明是数据报在网络中的寿命。
* 协议：占8位，协议字段指出此数据报携带的数据是使用何种协议，以便使目的主机的IP层知道应将数据部分上交给哪个处理过程。 
* 首部检验和：占16位。
* 源IP地址：占32位。 
* 目的IP地址：占32位。

主要包含：IMCP协议（ping）、IP协议（TCP/IP协议组）

## TCP协议

**TCP协议是面向连接、保证高可靠性(数据无丢失、数据无失序、数据无错误、数据无重复到达)传输层协议。**

协议头（20字节）：

* 源端口号[2字节]
* 目的端口号[2字节]
* SEQ序号[4字节]
* ACK序号[4字节]
* 偏移[0.5字节]
* Reserved [0.5字节]
* 标志[1字节]
* 窗口大小(window)[2字节]
* 校验和[2字节]
* 紧急指针[2字节]

主要涉及技术：三次握手链接、四次挥手关闭链接、TCP可靠性的保证（带重传功能的肯定确认）、滑动窗口技术

## UDP协议

**UDP协议也是传输层协议，它是无连接，不保证可靠的传输层协议。**

协议头（8字节）：

* 源端口号[2字节]
* 目的端口号[2字节]
* Length[2字节]
* 校验和[2字节]

## TCP和UDP协议的小结

### TCP

**提供IP环境下的数据可靠传输**，它提供的服务包括数据流传送、可靠性、有效流控、全双工操作和多路复用。TCP通过面向连接、端到端和可靠的数据包发送。**通俗说，它是事先为所发送的数据开辟出连接好的通道，然后再进行数据发送。**

TCP对应的是可靠性要求高的应用，支持的应用协议主要有：Telnet、FTP、SMTP等

### UDP

**UDP则不为IP提供可靠性、流控或差错恢复功能**

UDP对应的则是可靠性要求低、传输经济的应用，支持的应用层协议主要有：NFS（网络文件系统）、SNMP（简单网络管理协议）、DNS（主域名称系统）、TFTP（通用文件传输协议）等

### 区别：

1. 基于连接与无连接； 
2. 对系统资源的要求（TCP较多，UDP少）； 
3. UDP程序结构较简单； 
4. 流模式与数据报模式 ；
5. TCP保证数据正确性，UDP可能丢包，TCP保证数据顺序，UDP不保证。

## TCP/IP协议

传输控制协议/因特网互联协议，又名网络通讯协议，是Internet最基本的协议、Internet国际互联网络的基础，**由网络层的IP协议和传输层的TCP协议组成。**通俗而言：TCP负责发现传输的问题，一有问题就发出信号，要求重新传输，直到所有数据安全正确地传输到目的地。而IP是给因特网的每一台联网设备规定一个地址。

通过层次结构中可以看到，TCP/IP协议涉及到网络层和传输控制层，可以说是网络传输的基础。设备连接入网络，比如手机设备，就是实现了底层TCP协议后才可以在网络上进行传输。

### TCP/IP协议和UDP协议的关系

TCP/IP是协议族，由TCP和IP协议构成，TCP负责发现问题，请求重传，IP负责确立链路链接。

UDP是不可靠传输，也可以说是UDP/IP协议族，可是一般情况下意义不大，比较传输层都是会经过网络层的。

----

## Socket

socket是对TCP/UDP协议的封装和应用（编程角度）。所以属于对传输控制层的操作，主要解决数据在网络中传输的问题；而HTTP是应用层协议，主要解决如何包装数据。简单的说，**就是HTTP协议通信功能是利用了Socket封装的TCP/IP协议接口所实现的。**例如，在java中可以分为udp Socket和tcp Socket。

**Socket本身并不是协议，而是对TCP/IP协议的封装，是一个调用接口（API），通过Socket，我们才能使用TCP/IP协议。 **实际上，Socket跟TCP/IP协议没有必然的联系。Socket编程接口在设计的时候，就希望也能适应其他的网络协议。所以说，Socket的出现 只是使得程序员更方便地使用TCP/IP协议栈而已，是对TCP/IP协议的抽象，从而形成了我们知道的一些最基本的函数接口，比如create、 listen、connect、accept、send、read和write等等。

**可以跨平台，跨语言（需要注意编码等问题）**

## HTTP协议

HTTP协议是Web联网的基础，也是手机联网常用的协议之一，**HTTP协议是建立在TCP协议之上的一种应用。**

HTTP连接最显著的特点是客户端发送的每次请求都需要服务器回送响应，在请求结束后，会主动释放连接。从建立连接到关闭连接的过程称为“一次连接”。
 
1）在HTTP 1.0中，客户端的每次请求都要求建立一次单独的连接，在处理完本次请求后，就自动释放连接。
2）在HTTP 1.1中，规定了默认保持长连接（HTTP persistent connection ，也有翻译为持久连接），数据传输完成了保持TCP连接不断开（不发RST包、不四次握手），等待在同域名下继续用这个通道传输数据
 
### 短连接

由于HTTP在每次请求结束后都会主动释放连接，因此HTTP连接是一种“短连接”，要保持客户端程序的在线状态，需要不断地向服务器发起连接请求。通常的做法是即时不需要获得任何数据，客户端也保持每隔一段固定的时间向服务器发送一次“保持连接”的请求，服务器在收到该请求后对客户端进行回复，表明知道客户端“在线”。若服务器长时间无法收到客户端的请求，则认为客户端“下线”，若客户端长时间无法收到服务器的回复，则认为网络已经断开。

### 长连接

数据传输完成了保持TCP连接不断开，进行下一次传输，从而减少创建链接和关闭链接的资源消耗。

从HTTP1.1中，就可以添加HTTP首部的Connection: Keep-alive来达到长连接的目的。当然不能让服务器无休止的等下去，一般还会设置Keep-Alive: timeout=20，链接的保持时间。

更多长连接的问题：http://www.cnblogs.com/skynet/archive/2010/12/11/1903347.html

## Socket和HTTP、TCP/IP小结

### SOCKET连接与TCP/IP连接

创建Socket连接时，可以指定使用的传输层协议，Socket可以支持不同的传输层协议（TCP或UDP），当使用TCP协议进行连接时，该Socket连接就是一个TCP连接。

### Socket连接与HTTP连接

Socket连接通常情况下就是TCP连接，因此Socket连接一旦建立，通信双方即可开始相互发送数据内容，直到双方连接断开。但在实际网络应用中，客户端到服务器之间的通信往往需要穿越多个中间节点，例如路由器、网关、防火墙等，大部分防火墙默认会关闭长时间处于非活跃状态的连接而导致 Socket 连接断连。因此Socket链接中，客户端需要通过轮询告诉服务器网络，该连接处于活跃状态。
 
HTTP连接使用的是“请求—响应”的方式，不仅在请求时需要先建立连接，而且需要客户端向服务器发出请求后，服务器端才能回复数据。
 
很多情况下，需要服务器端主动向客户端推送数据，保持客户端与服务器数据的实时与同步。此时若双方建立的是Socket连接，服务器就可以直接将数据传送给客户端；若双方建立的是HTTP连接，则服务器需要等到客户端发送一次请求后才能将数据传回给客户端，因此，客户端定时向服务器端发送连接请求，不仅可以保持在线，同时也是在“询问”服务器是否有新的数据，如果有就将数据传给客户端。

### TCP/IP连接和HTTP连接

HTTP是应用层协议，TCP/IP是传输层协议族，因此可以理解为，HTTP链接是基于TCP/IP连接所实现的。

HTTP工作原理：

1. 封成HTTP请求数据包
2. 封成TCP包
3. 建立TCP连接（三次握手）
4. 客户端发请求
5. 服务器返回响应
6. 服务器关闭TCP连接（四次挥手）

----

## PRC通信（Remote Procedure Call Protocol）

RPC**使用C/S方式，采用http协议,发送请求到服务器，等待服务器返回结果。**这个请求包括一个参数集和一个文本集，通常形成“classname.methodname”形式。优点是跨语言跨平台，C端、S端有更大的独立性，缺点是不支持对象，无法在编译器检查错误，只能在运行期检查。

## Web Service

WebService是一种跨编程语言和跨操作系统平台的远程调用技术。Web Service提供的服务是**基于web容器的，底层使用http协议，类似一个远程的服务提供者**，比如天气预报服务，对各地客户端提供天气预报，是一种请求应答的机制，是跨系统跨平台的。就是通过一个servlet，提供服务出去。

原理：

1. 采用HTTP协议传输数据
2. 采用XML格式封装数据
3. 利用SOAP协议封装， SOAP协议 = HTTP协议 + XML数据格式。SOAP协议是基于HTTP协议的，SOAP也是基于XML和XSD的，XML是SOAP的数据编码方式。打个比喻：HTTP就是普通公路，XML就是中间的绿色隔离带和两边的防护栏，SOAP就是普通公路经过加隔离带和防护栏改造过的高速公路。 
4. WSDL描述文件（存储在中心服务器）。基于XML的语言，用于描述Web Service可以调用的服务及其函数、参数和返回值。
5. （可选）UDDI目录服务，企业可以使用它对Webservices进行注册和搜索，如查找WSDL文件

运行流程：

提供者：

设计服务，并将服务的描述文件WSDL在UDDI服务中心注册（发布服务）

消费者：

1. 通过UDDI查找或手动设定WSDL地址，找到服务（发现服务）
2. 解析WSDL描述文件，并连接服务提供者（绑定服务）
3. 发送SOAP消息，并得到提供者处理后的返回（消费服务）

## HttpRequest

通常的HttpRequest是指利用HTTP的GET或POST方法发送JSON/XML数据，进行数据的传输。

具体参考HTTP传输协议

## RMI （Remote Method Invocation）
RMI 采用stubs 和 skeletons 来进行远程对象(remote object)的通讯。stub 充当远程对象的客户端代理，有着和远程对象相同的远程接口，远程对象的调用实际是通过调用该对象的客户端代理对象stub来完成的，通过该机制RMI就好比它是本地工作，采用tcp/ip协议，客户端直接调用服务端上的一些方法。优点是强类型，编译期可检查错误，缺点是只能基于JAVA语言，客户机与服务器紧耦合。
 
## JMS（Java Messaging Service）
JMS是Java的消息服务，JMS的客户端之间可以通过JMS服务进行异步的消息传输。JMS支持两种消息模型：Point-to-Point（P2P）和Publish/Subscribe（Pub/Sub），即点对点和发布订阅模型。

## RPC、RMI与WebServer

### RPC

跨语言，不支持对象的概念。当一个请求到达RPC服务器时，这个请求就包含了一个参数集和一个文本值，通常形成“classname.methodname”的形式。这就向RPC服务器表明，被请求的方法在为 “classname”的类中，名叫“methodname”。

### RMI

只支持java，允许方法返回 Java 对象以及基本数据类型（序列化），每个远程方法都具有方法签名。

### WebServer

webservice是在http协议上传递xml文本文件，与语言和平台无关，并且通过描述文件WSDL进行方法的选择。

## JMS、RMI与WebServer

### JMS

JMS是异步的，松耦合的，消息通知机制（对象是在物理上被异步从网络的某个JVM 上直接移动到另一个JVM 上）

### RMI

RMI一般都是同步的，紧耦合的，请求应答机制（对象是绑定在本地JVM 中，只有函数参数和返回值是通过网络传送的）

### WebServer

Webservice专注于远程服务调用，和RMI类似，是同步的，紧耦合的，请求应答机制的。同时需要有复杂的转换

## WebServer与HttpRequest

WebServer是基于HTTP实现的，效率上肯定是要低于HttpRequest。但是在复杂的应用中，例如对Soap协议的使用就是需要WebServer来完成。

HttpRequest对于单纯的取数据是可以的。用 XML 或者 JSON 单向从服务器取数据。而用WebServer的Soap协议是指，客户端调用服务器端上定义的方法（类似RPC）

## 小结

	RPC 跨语言 跨平台
	RMI 只支持java
	JMS 只支持java
	WebServer 跨语言 跨平台
	Socket 跨语言 跨平台
	HTTP 跨语言 跨平台
	应用层：HTTP		-> HTTP RPC WebServer
	传输层：TCP/IP	-> RMI SOCKET JMS